pipeline:
  name: stepgrouptest
  identifier: stepgrouptest
  projectIdentifier: Labs
  orgIdentifier: Customer_Experience
  tags: {}
  stages:
    - stage:
        name: stepgroup
        identifier: stepgroup
        description: ""
        type: Custom
        spec:
          execution:
            steps:
              - stepGroup:
                  name: stepgroup
                  identifier: stepgroup
                  steps:
                    - step:
                        type: GitClone
                        name: GitClone_1
                        identifier: GitClone_1
                        spec:
                          connectorRef: org.githubthroughdelegate
                          repoName: demo-repo
                          build:
                            type: branch
                            spec:
                              branch: main
                    - step:
                        type: Run
                        name: Run_1
                        identifier: Run_1
                        spec:
                          connectorRef: podinfodockerconnectorpublish
                          image: nginx:latest
                          shell: Sh
                          command: |-
                            echo "Install JQ and set environment variables"
                            curl -L -o /usr/local/bin/jq https://github.com/jqlang/jq/releases/download/jq-1.6/jq-linux64 \
                                && chmod +x /usr/local/bin/jq
                                
                            #source jq -r '.[] | "export \(.name)=\(.value)"' /harness/demo-repo/env.json
                            eval "$(jq -r '.[] | "export \(.name)=\(.value)"' /harness/demo-repo/env.json)"

                            #export output=$(jq -r '.[] | "\(.name): \(.value)"' /harness/demo-repo/env.json)
                            #export output=$(jq -r '.[] | "\(.name): \(.value)\\n"' /harness/demo-repo/env.json)
                            export output=$(jq -r '.[] | "  \(.name): \(.value)"' /harness/demo-repo/env.json)
                            env

                            apt update
                            apt install procps -y

                            sleep 10000
                          envVariables:
                            test: value1
                            test2: value2
                          outputVariables:
                            - name: ENV_VARIABLE
                              type: String
                              value: output
                  stepGroupInfra:
                    type: KubernetesDirect
                    spec:
                      connectorRef: k8sdemoconnector
            rollbackSteps: []
          serviceDependencies: []
        tags: {}
    - stage:
        name: run-tests
        identifier: runtests
        description: ""
        type: Pipeline
        spec:
          org: Customer_Experience
          pipeline: stepgrouptest_Clone
          project: Labs
          inputs:
            identifier: stepgrouptest_Clone
            stages:
              - stage:
                  identifier: stepgroup
                  type: Custom
                  spec:
                    execution:
                      steps:
                        - stepGroup:
                            identifier: stepgroup
                            steps:
                              - step:
                                  identifier: Run_2
                                  type: Run
                                  spec:
                                    envVariables:
                                      "0": <
                                      "1": +
                                      "2": p
                                      "3": i
                                      "4": p
                                      "5": e
                                      "6": l
                                      "7": i
                                      "8": "n"
                                      "9": e
                                      "10": .
                                      "11": s
                                      "12": t
                                      "13": a
                                      "14": g
                                      "15": e
                                      "16": s
                                      "17": .
                                      "18": s
                                      "19": t
                                      "20": e
                                      "21": p
                                      "22": g
                                      "23": r
                                      "24": o
                                      "25": u
                                      "26": p
                                      "27": .
                                      "28": s
                                      "29": p
                                      "30": e
                                      "31": c
                                      "32": .
                                      "33": e
                                      "34": x
                                      "35": e
                                      "36": c
                                      "37": u
                                      "38": t
                                      "39": i
                                      "40": o
                                      "41": "n"
                                      "42": .
                                      "43": s
                                      "44": t
                                      "45": e
                                      "46": p
                                      "47": s
                                      "48": .
                                      "49": s
                                      "50": t
                                      "51": e
                                      "52": p
                                      "53": g
                                      "54": r
                                      "55": o
                                      "56": u
                                      "57": p
                                      "58": .
                                      "59": s
                                      "60": t
                                      "61": e
                                      "62": p
                                      "63": s
                                      "64": .
                                      "65": R
                                      "66": u
                                      "67": "n"
                                      "68": _
                                      "69": "1"
                                      "70": .
                                      "71": o
                                      "72": u
                                      "73": t
                                      "74": p
                                      "75": u
                                      "76": t
                                      "77": .
                                      "78": o
                                      "79": u
                                      "80": t
                                      "81": p
                                      "82": u
                                      "83": t
                                      "84": V
                                      "85": a
                                      "86": r
                                      "87": i
                                      "88": a
                                      "89": b
                                      "90": l
                                      "91": e
                                      "92": s
                                      "93": .
                                      "94": E
                                      "95": "N"
                                      "96": V
                                      "97": _
                                      "98": V
                                      "99": A
                                      "100": R
                                      "101": I
                                      "102": A
                                      "103": B
                                      "104": L
                                      "105": E
                                      "106": ">"
  variables:
    - name: pipelinevariable
      type: String
      description: ""
      required: false
      value: <+input>
